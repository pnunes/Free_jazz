<?php  if ( session_status() !== PHP_SESSION_ACTIVE ) {    session_start();  }   //carrega variaveis com dados para acessar o banco de dados   Include('conexao_free.php');  mysqli_set_charset($con,'UTF8');     //verifica se o usuário esta habilitado para usar a rotina   $matricula_m  =$_SESSION['matricula_m'];  $programa='040';  $_SESSION['programa_m']=$programa;    $confere = "SELECT matricula,programa  FROM permissoes  WHERE ((matricula='$matricula_m') and (programa='$programa'))";  $query = mysqli_query($con,$confere) or die ("Não foi possivel acessar o banco - Rotina Cadastro Destinos");  $achou = mysqli_num_rows($query);  If ($achou == 0 ) {       ?>          <script language="javascript"> window.location.href=("entrada.php")            alert('Você não está autorizado a acessar esta rotina.');          </script>       <?php  }    if ($_SESSION['entrada_m']=='S')  {	  	   $_SESSION['entrada_m']       ='N';       $dt_envio                    ='';	   $_SESSION['dt_envio_m']      ='';       $n_remessa                 ='';	   $_SESSION['n_remessa_m']   ='';       $nome_cliente = '';       $dt_envio_m	 = '';        $resp_grava   = '';	     }    function get_post_action($name) {	 $params = func_get_args();	 foreach ($params as $name) {	   if (isset($_POST[$name])) {		   return $name;	   }	 }  }  $resp_grava   = '';   switch (get_post_action('gera','imprime','grava')) {       case 'gera':              $ultimo = "SELECT * FROM nu_reme_manu ORDER BY numero DESC LIMIT 1";				  $query = mysqli_query($con,$ultimo) or die ("Não foi possivel acessar o banco");				  $total = mysqli_num_rows($query);				  				  if($total > 0){				    for($ic=0; $ic<$total; $ic++){					    $row = mysqli_fetch_row($query);					    $n_reme           = $row[0];				    }				  }				  else {					 $n_reme =0; 				  }				  				  $n_remessa  = sprintf("%07d",$n_reme+1);				  				  //$_SESSION['n_reme'] =$n_reme;				  				  //Retira os traços da string				  //$n_remessa    =str_replace('-','',$n_remessa);                  				  $_SESSION['n_remessa_m'] = $n_remessa;				                    if(isset($_SESSION['v_dt_envio_m'])) {                     $v_dt_envio   =$_SESSION['v_dt_envio_m'];				  }				  else {					 $v_dt_envio   ='';				  }                  $dt_envio                    =$_POST['dt_envio'];                  $_SESSION['dt_envio_m']      =$dt_envio;				                   $dt_envio_c  = explode("/",$dt_envio);                  $v_dt_envio = $dt_envio_c[2]."-".$dt_envio_c[1]."-".$dt_envio_c[0];                  $_SESSION['v_dt_envio_m']   =$v_dt_envio;       break;              case 'grava':               $n_hawb       =$_POST['n_hawb'];               $dt_envio     =$_SESSION['dt_envio_m'];               $n_remessa    =$_SESSION['n_remessa_m'];			                  if (($n_hawb<>'') and ($n_remessa<>'') and ($dt_envio<>'')) {                       $_SESSION['n_hawb_m'] =$n_hawb;                       $resp_grava='';                                              $verifi="SELECT controle,codi_cli,cod_barra FROM remessa                       WHERE ((n_hawb='$n_hawb') AND (dt_baixa<>'0000-00-00'))";                       $query = mysqli_query($con,$verifi) or die ("Não foi possivel acessar o banco");                       $total = mysqli_num_rows($query);                       //Verifica se omovimento foi lançaado                       If ($total == 0 ) {                          $n_hawb='';                          ?>                          <script language="javascript"> window.location.href=("envia_fisico_remessa.php")                           alert('Esta HAWB ainda não foi baixada (BIP 3) ou não foi lançada no sistema (BIP 1)! Verifique.');                          </script>                          <?php                       }                       else {                            for($ic=0; $ic<$total; $ic++){                               $mostra = mysql_fetch_row($query);                               $controle       = $mostra[0];                               $codi_cli       = $mostra[1];                               $codi_barra     = $mostra[2];                            }                            $_SESSION['controle_m']    =$controle;                            $_SESSION['codi_cli_m']    =$codi_cli;                            $_SESSION['cod_barra_m']   =$codi_barra;                            //Verifica se a HAWB lançaada já tem entregador definido                                                        $verifica = "SELECT dt_envio FROM remessa WHERE controle='$controle'";                            $query_v = mysqli_query($con,$verifica) or die ("Não foi possivel acessar o banco 1");                            $total = mysqli_num_rows($query_v);                            for($i=0; $i<$total; $i++){                               $dados = mysqli_fetch_row($query_v);                               $data_enviado      =$dados[0];                            }                            If ($data_enviado == '0000-00-00') {                               //Pega nome clinete na tabela cli_for                               $resultado = mysqli_query ($con,"SELECT nome FROM cli_for                               WHERE cnpj_cpf='$codi_cli'");                               $total = mysqli_num_rows($resultado);                               for($i=0; $i<$total; $i++){                                  $dados = mysqli_fetch_row($resultado);                                  $nome_cliente      =$dados[0];                               }                               $_SESSION['nome_cliente_m']   =$nome_cliente;							                                  //verifica se o registro é do mesmo cliente                               $v_dt_envio       =$_SESSION['v_dt_envio_m'];                               $controle         =$_SESSION['controle_m'];                               $n_remessa        =$_SESSION['n_remessa_m'];                               $codi_cli         =$_SESSION['codi_cli_m'];                                                              $pesquisa = mysqli_query ($con,"SELECT codi_cli FROM remessa                               WHERE controle='$controle'");                               $total = mysqli_num_rows($pesquisa);                               for($i=0; $i<$total; $i++){                                  $dados = mysqli_fetch_row($pesquisa);                                  $c_codicli      =$dados[0];                               }                               if ($c_codicli==$codi_cli) {                                   //Efetua a gravaçãoda alteraçãono registro                                                                      $alteracao = "UPDATE remessa SET dt_envio='$v_dt_envio',remessa_envio='$n_remessa',estatus='BIP4'                                   WHERE controle='$controle'";                                   if (mysqli_query($con,$alteracao)) {                                      //Atualiza a tabela log_operação sistema                                      $programa     =$_SESSION['programa_m'];                                      $matricula_m  =$_SESSION['matricula_m'];                                      $hora         = date ('H:i:s');                                      $data         = date('Y-m-d');                                      $n_hawb       =$_SESSION['n_hawb_m'];                                                                            $inclui="INSERT INTO log_operacao_sistema(matricula,tarefa_executada,data,hora,rotina,n_hawb)                                      VALUES('$matricula_m','Elabora Lista Envio HAWB Origem','$data','$hora','$programa','$n_hawb')";                                      mysqli_query($con,$inclui);                                      $codi_barra  =$_SESSION['cod_barra_m'];									                                        $confere = "SELECT controle FROM controle_reentrega WHERE n_hawb='$n_hawb' and ocorrencia='HAWB devolvida a origem.'";                                      $query_v = mysqli_query($con,$confere) or die ("Não foi possivel acessar o banco");                                      $total = mysqli_num_rows($query_v);                                      if ($total==0) {                                         //////////////////Atualiza a tabela de histórico HAWB /////////////////////////////////                                         $atualiza="INSERT INTO controle_reentrega (n_hawb,dt_evento,ocorrencia,cod_barra,ordem)                                         VALUES('$n_hawb','$v_dt_envio','HAWB devolvida a origem.','$codi_barra','4')";                                         mysqli_query($con,$atualiza);                                      }                                      $resp_grava="Registro bem sucedido na remessa de envio!";                                      //Atualiza a tabela de controle de numero de remessas                                      $n_remes    =$_SESSION['n_remessa_m'];                                                                            $verifi="SELECT numero FROM nu_reme_manu WHERE numero='$n_remes'";                                      $query = mysqli_query($con,$verifi) or die ("Não foi possivel acessar o banco_2");                                      $achou = mysqli_num_rows($query);                                      echo "<p>Achou :$achou";                                      If ($achou == 0 ) {                                         $atualiza = "INSERT INTO nu_reme_manu(numero,dt_remessa)                                         values('$n_remes','$v_dt_envio')";                                         mysqli_query($con,$atualiza);                                      }                                      $codi_barra          ='';                                      $controle            ='';                                                                            unset($_SESSION['controle_m']);                                      unset($_SESSION['cod_barra_m']);                                      $n_remessa  =$_SESSION['n_remessa_m'];                                   }                                   else {                                      $resp_grava="Problemas no registroda remessa de envio";                                      $codi_barra          ='';                                      $controle            ='';                                                                           unset($_SESSION['controle_m']);                                      unset($_SESSION['cod_barra_m']);                                   }                               }                            }                       }               }           break;           case 'imprime':               $n_remessa    =$_SESSION['n_remessa_m'];                               $pega_cli=mysqli_query($con,"SELECT DISTINCT remessa.codi_cli,cli_for.nome               FROM remessa,cli_for               WHERE ((remessa.remessa_envio='$n_remessa')               AND (remessa.codi_cli=cli_for.cnpj_cpf))");               $total = mysqli_num_rows($pega_cli);               for($i=0; $i<$total; $i++){                 $dados = mysqli_fetch_row($pega_cli);                 $codigo        =$dados[0];                 $nome_cliente  =$dados[1];               }               $_SESSION['nome_cliente_m']  =$nome_cliente;               require_once("gera_relat_remessa_envio.php");          break;          default:       }       include ("campo_calendario.php");	          if(isset($_POST['cod_barra'])) {          $codi_barra     =$_POST['cod_barra'];	   }	   else {		  $codi_barra     =''; 	   }	   	   if(isset($_SESSION['dt_envio_m'])) {          $dt_envio       =$_SESSION['dt_envio_m'];	   }	   else {		  $dt_envio       =''; 	   }	   if(isset($_SESSION['n_remessa_m'])) {          $n_remessa    =$_SESSION['n_remessa_m'];	   }	   else {		  $n_remessa    =''; 	   }		         if (($codi_barra<>'') and ($n_remessa<>'') and ($dt_envio<>'')) {               $_SESSION['cod_barra_m'] =$codi_barra;               $resp_grava='';                              $verifi="SELECT controle,codi_cli,n_hawb FROM remessa               WHERE ((cod_barra='$codi_barra')               AND (dt_baixa<>'0000-00-00'))";               $query = mysqli_query($con,$verifi) or die ("Não foi possivel acessar o banco");               $total = mysqli_num_rows($query);               //Verifica se omovimento foi lançado               If ($total == 0 ) {                  $codi_barra='';                  ?>                  <script language="javascript"> window.location.href=("envia_fisico_remessa.php")                   alert('Esta HAWB ainda não foi baixada (BIP 3) ou não foi lançada no sistema (BIP 1)! Verifique.');                  </script>                  <?php               }               else {		                         for($ic=0; $ic<$total; $ic++){                         $mostra = mysqli_fetch_row($query);                         $controle       = $mostra[0];						 $codi_cli       = $mostra[1];                         $n_hawb         = $mostra[2];					  }                      $_SESSION['controle_m']    =$controle;					  if(isset($codi_cli)){                          $_SESSION['codi_cli_m']    =$codi_cli;					  }					  else {						  $_SESSION['codi_cli_m']    ='';					  }					  if(isset($n_hawb)){                          $_SESSION['n_hawb_m']      =$n_hawb;					  }					  else {						  $_SESSION['n_hawb_m']      ='';					  }					                        //Verifica se a HAWB lançaada já foi enviada                                          $verifica = "SELECT dt_envio FROM remessa WHERE controle='$controle'";                      $query_v = mysqli_query($con,$verifica) or die ("Não foi possivel acessar o banco 1");                      $total = mysqli_num_rows($query_v);                      for($i=0; $i<$total; $i++){                         $dados = mysqli_fetch_row($query_v);                         $data_enviado      =$dados[0];                      }                      If ($data_enviado == '0000-00-00') {                         //Pega nome cliente na tabela cli_for                                                $resultado = mysqli_query ($con,"SELECT nome FROM cli_for                         WHERE cnpj_cpf='$codi_cli'");                         $total = mysqli_num_rows($resultado);                         for($i=0; $i<$total; $i++){                            $dados = mysqli_fetch_row($resultado);                            $nome_cliente      =$dados[0];                         }                         $_SESSION['nome_cliente_m']   =$nome_cliente;                         //verifica se o registro é do mesmo cliente                         $v_dt_envio       =$_SESSION['v_dt_envio_m'];                         $controle         =$_SESSION['controle_m'];                         $n_remessa        =$_SESSION['n_remessa_m'];                         $codi_cli         =$_SESSION['codi_cli_m'];                                                $pesquisa = mysqli_query ($con,"SELECT codi_cli FROM remessa                         WHERE controle='$controle'");                         $total = mysqli_num_rows($pesquisa);                         for($i=0; $i<$total; $i++){                            $dados = mysqli_fetch_row($pesquisa);                            $c_codicli      =$dados[0];                         }                         if ($c_codicli==$codi_cli) {                                                      $alteracao = "UPDATE remessa SET dt_envio='$v_dt_envio',remessa_envio='$n_remessa'                           WHERE controle='$controle'";                           if (mysqli_query($con,$alteracao)) {                              //Atualiza a tabela log_operação sistema                              $programa     =$_SESSION['programa_m'];                              $matricula_m  =$_SESSION['matricula_m'];                              $hora         = date ('H:i:s');                              $data         = date('Y-m-d');                              $n_hawb       =$_SESSION['n_hawb_m'];                              							  //atualiza a tabela de log do sistema                              $inclui="INSERT INTO log_operacao_sistema(matricula,tarefa_executada,data,hora,rotina,n_hawb)                              VALUES('$matricula_m','Elabora Lista Envio HAWB Origem','$data','$hora','$programa','$n_hawb')";                              mysqli_query($con,$inclui);							                                $codi_barra  =$_SESSION['cod_barra_m'];                              $confere = "SELECT controle FROM controle_reentrega WHERE n_hawb='$n_hawb' and ocorrencia='HAWB devolvida a origem.'";                              $query_v = mysqli_query($con,$confere) or die ("Não foi possivel acessar o banco");                              $total = mysqli_num_rows($query_v);                              if ($total==0) {                                 //////////////////Atualiza a tabela de histórico HAWB /////////////////////////////////                                 $atualiza="INSERT INTO controle_reentrega (n_hawb,dt_evento,ocorrencia,cod_barra,ordem)                                 VALUES('$n_hawb','$v_dt_envio','HAWB devolvida a origem.','$codi_barra','4')";                                 mysqli_query($con,$atualiza);                              }                                                            //Atualiza a tabela de controle de numero de remessas                              $n_remes    =$_SESSION['n_remessa_m'];                                                            $verifi="SELECT numero FROM nu_reme_manu WHERE numero='$n_remes'";                              $query = mysqli_query($con,$verifi) or die ("Não foi possivel acessar o banco_2");                              $achou = mysqli_num_rows($query);                                                            If ($achou == 0 ) {                                 $atualiza = "INSERT INTO nu_reme_manu(numero,dt_remessa)                                 values('$n_remes','$v_dt_envio')";                                 mysqli_query($con,$atualiza);                              }                              $codi_barra          ='';                              $controle            ='';                                                            unset($_SESSION['controle_m']);                              unset($_SESSION['cod_barra_m']);                              $n_remessa  =$_SESSION['n_remessa_m'];							  							  $resp_grava="Registro bem sucedido na remessa de envio!";                           }                           else {                              $resp_grava="Problemas no registroda remessa de envio";                           }                       }                    }               }			        }?><html>  <title>envia_fisico_remessa.php</title>  <head>   <style>		body, p, div, td, input, select, textarea {			font-family: verdana,arial,helvetica;			font-size:12px;			color:#000000;			text-decoration: none;		}		input,textarea {			@if (is.ie) {				color: #efefef; background-color:#F0F8FF; border: 1px solid #6495ED ;				/*border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; */			}		}		textarea { overflow:auto }   </style>   <script>       function salva(campo){            cadastro_1.submit()       }          <!-- FUNÇÃO PARA DESABILITAR O CRTL+J-->   function retornoCodbar(evt, valor){    <!--ENTER = 13 -->    if (window.event){       var tecla = window.event.keyCode;       if(tecla==13){         <!--alert('Código de barras: '+valor);-->         window.event.returnValue = false;       }    }    else{       var tecla = (evt.which) ? evt.which : evt.keyCode;       if(tecla==13){          <!--alert('Código de barras: '+valor);-->         evt.preventDefault();       }    }   }   function desabilitaCtrlJ(evt){      //ctrl+j == true+106      //ctrl+J == true+74      if (window.event){ //IE         var ctrl = event.ctrlKey;         var tecla = window.event.keyCode;         if((ctrl==true)&&((tecla==106)||(tecla==74))){            window.event.returnValue = false;         }      }      else{ //Firefox         var ctrl = evt.ctrlKey;         var tecla = (evt.which) ? evt.which : evt.keyCode;         if((ctrl==true)&&((tecla==106)||(tecla==74))){            evt.preventDefault();         }      }   }</script>      </script>  </head>  <div id="geral" align="center">    <body onkeydown="desabilitaCtrlJ(event)" topmargin="0" leftmargin="0" rightmargin="0" bottommargin="0" marginheight="0" marginwidth="0" bgcolor="#FFFFFF">     <table border="0" width="100%" bgcolor="#000000" cellspacing="0" cellpadding="0">      <tr>        <td width="20%" height="100" background="img/topleft.jpg"></td>         <td width="658" height="110"> <img border="0" src="img/cabecalho_free_jazz.jpg" width="890" height="115" border="0"></td>        <td width="15%" height="110">        <p align="right"><img border="0" src="img/topright.jpg" width="160" height="110" border="0"></td>     </tr>    </table>    <table border="0" width="100%" cellspacing="0" cellpadding="0" background="img/blue.jpg">     <tr>       <td width="50%">         <p align="left"><font face="Arial" size="2" color="#FFFFFF"><b>Sistema de Gerenciamento da Logística de Encomendas</b></font></td>       <td width="50%">         <p align="right"><font face="Arial" size="2" color="#FFFFFF"><b>Elabora Lista de Entrega Com Leitora</b></font></td>     </tr>   </table>   </table>   <table width="100%" border="0" cellspacing="0" cellpadding="0">       <tr>         <td colspan="1" align="left" width="45%"><INPUT type=button size="3" value="Ajuda"               onClick="window.open('mostra_ajuda.php','janela_1',               'scrollbars=yes,resizable=yes,width=400,height=700');" style="width:100;height:30;color=red;font: bold 16px Arial;">         </td>         <td colspan="1" color="white" align="right" width="45%" height="70"><a href="entrada.php"><img src="img/porta.gif" border="none"></td>       </tr>   </table>   <form method="POST" name="cadastro" action="envia_fisico_remessa.php" border="20" align="center">      <table width="80%" heigth="300">        <tr>          <td colspan="3"  align="center">            <b>Data Envio :</b>            <?php 			    if(isset($_SESSION['dt_envio_m'])) {			        $dt_envio  =$_SESSION['dt_envio_m'];				}				else {					$dt_envio  ='';				}			?>            <input type="text" name="dt_envio" value ="<?php echo "$dt_envio";?>" size="12" maxlength="12" id="dt_envio">            <input TYPE="button" NAME="btndt_envio" VALUE="..." Onclick="javascript:popdate('document.cadastro.dt_envio','pop1','150',document.cadastro.dt_envio.value)">            <span id="pop1" style="position:absolute"></span>          </td>        </tr>        <tr align="center">			<td  align="center"><b>Remessa de Envio :</b>			<?php 			   if(isset($_SESSION['n_remessa_m'])) {			      $n_remessa  =$_SESSION['n_remessa_m'];			   }			   else {				  $n_remessa  =''; 			   }			?>			<input name="remessa_envio" type="text" value ="<?php echo "$n_remessa";?>" size="17" maxlength="17" id="remessa_envio"><input name="gera" type="submit" value="Gera Remessa"></td></td>		</tr>      </table>       <table width="100%" border="1" cellpadding="5" cellspacing="0" bordercolor="#4169E1">         <tr>		    <?php 			   if(!isset($nome_cliente)) {			      $nome_cliente  ='';			   }			?>           <td colspan="7" align="center"><font face="arial" size="2"><b>ENVIO FÍSICO PARA :<?php echo "$nome_cliente";?></b></font></td>         </tr>         <tr>           <td width="2%" align="center"><b>N.</b></td>           <td width="5%" align="center"><b>N. HAWB</b></td>           <td width="24%" align="center"><b>NOME</b></td>           <td width="24%" align="center"><b>RUA</b></td>           <td width="5%" align="center"><b>NUMERO</b></td>           <td width="20%" align="center"><b>BAIRRO</b></td>           <td width="15%" align="center"><b>CIDADE</b></td>         </tr>        <?php		 if(isset($_SESSION['n_remessa_m'])) {            $n_remessa   =$_SESSION['n_remessa_m'];		 }		 else {			$n_remessa=''; 	     }                  $resultado = mysqli_query ($con,"SELECT n_hawb,nome_desti,rua_desti,numero_desti,bairro_desti,cidade_desti         FROM remessa         WHERE ((remessa_envio='$n_remessa')		 AND (remessa_envio<>'')         AND(remessa_envio<>'0000-00-00')		 AND (remessa_envio<>''))");         $total = mysqli_num_rows($resultado);         $ni=0;         for($i=0; $i<$total; $i++){          $dados = mysqli_fetch_row($resultado);          $n_hawb            =$dados[0];          $nome_desti        =$dados[1];          $rua_desti         =$dados[2];          $numero_desti      =$dados[3];          $bairro_desti      =$dados[4];          $cidade_desti      =$dados[5];          $ni=$i+1;          echo "<tr>";            echo "<td width=\"2%\" align=\"left\"><font size=\"1\" face=\"arial\">$ni</font></td>";            echo "<td width=\"5%\" align=\"left\"><font size=\"1\" face=\"arial\">$n_hawb</font></td>";            echo "<td width=\"24%\"><font size=\"1\" face=\"arial\">$nome_desti</font></td>";            echo "<td width=\"24%\"><font size=\"1\" face=\"arial\">$rua_desti</font></td>";            echo "<td width=\"5%\"><font size=\"1\" face=\"arial\">$numero_desti</font></td>";            echo "<td width=\"20%\"><font size=\"1\" face=\"arial\">$bairro_desti</font></td>";            echo "<td width=\"15%\"><font size=\"1\" face=\"arial\">$cidade_desti</font></td>";         echo "</tr>";       }    ?>    <tr>      <td colspan="7">        <div align="right">         <input name="imprime" type="submit" value="Imprimir">        </div>      </td>    </tr>  </form>  <body leftmargin="10" topmargin="10" marginwidth="10" marginheight="10">  <form name="cadastro_1" action="envia_fisico_remessa.php" method="post">	<table width="50%" border="1" align="center" cellpadding="5" cellspacing="0" bordercolor="#4169E1">       <tr>           <td align="center" colspan="3"><b>Codigo Barras:</b>           <input type="text" name="cod_barra" id="cod_barra" size="50" maxlength="50" onChange="salva(this)"></td>       </tr>       <!-- Coloca foco no primeiro campo codigo de barras do formulário -->       <script language="JavaScript">          document.getElementById('cod_barra').focus()       </script>       <tr>           <td><b>Número da HAWB:</b></td>           <td><input type="text" name="n_hawb" class="campo" id="n_hawb"><input name="grava" type="submit" value="Grava"></td></td>	   </tr>   	</table>  </form>  </div>  <table width="100%" border="0" cellspacing="0" cellpadding="0" align="center">      <tr>        <td color="white" align="center" width="900" height="45" colspan="8" ><?php echo "$resp_grava";?></td>      </tr>  </table>  <table width="100%" border="0" cellspacing="0" cellpadding="0">    <tr>       <td color="white" align="left" width="100%" height="40">     </tr>  </table>  <table width="100%"  border="0" cellspacing="0" cellpadding="0">    <tr>      <td background="img/blue.jpg" align="left" width="100%" height="45px"><center><font face="arial" size="1" color="white">Todos Direitos Reservados a NUNESTEC Tecnologia</font></td>    </tr>  </table></body></html>