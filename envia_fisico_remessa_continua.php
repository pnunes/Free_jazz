<?php   if ( session_status() !== PHP_SESSION_ACTIVE ) {     session_start();   }    //carrega variaveis com dados para acessar o banco de dados    Include('conexao_free.php');   mysqli_set_charset($con,'UTF8');      //verifica se o usuário esta habilitado para usar a rotina    $matricula_m  =$_SESSION['matricula_m'];   $programa='041';   $_SESSION['programa_m']=$programa;     $confere = "SELECT matricula,programa   FROM permissoes   WHERE ((matricula='$matricula_m') and (programa='$programa'))";   $query = mysqli_query($con,$confere) or die ("Não foi possivel acessar o banco - Rotina Cadastro Destinos");   $achou = mysqli_num_rows($query);   If ($achou == 0 ) {       ?>          <script language="javascript"> window.location.href=("entrada.php")            alert('Você não está autorizado a acessar esta rotina.');          </script>       <?php   }     if ($_SESSION['entrada_m']=='S')  {	  	   $_SESSION['entrada_m']       ='N';       $dt_envio                    ='';	   $t_dt_envio                  =	   $_SESSION['dt_envio_m']      ='';       $n_remessa                   ='';	   $_SESSION['n_remessa_m']     ='';       $cliente                     = '';       $dt_envio_m	                = '';        $resp_grava                  = '';	      }   function get_post_action($name) {      $params = func_get_args();      foreach ($params as $name) {         if (isset($_POST[$name])) {            return $name;         }      }   }   $resp_grava ='';    switch (get_post_action('seleciona','imprime','grava')) {        case 'grava':               $v_n_remessa  =$_SESSION['n_remessa_m'];               $n_hawb       =$_POST['n_hawb'];               $dt_envio     =$_SESSION['dt_envio_m'];			                  if (($n_hawb<>'') and ($v_n_remessa<>'') and ($dt_envio<>'')) {                   $resp_grava='';                                      $verifi="SELECT controle,codi_cli,n_hawb,remessa_envio,dt_envio,dt_baixa,cod_barra                   FROM remessa                   WHERE n_hawb='$n_hawb'";                   $query = mysqli_query($con,$verifi) or die ("Não foi possivel acessar o banco");                   $total = mysqli_num_rows($query);                   //Verifica se omovimento foi lançado                   If ($total == 0 ) {                      $$n_hawb='';                      ?>                      <script language="javascript"> window.location.href=("envia_fisico_remessa.php")                       alert('Esta HAWB não foi lançaada no sistema (BIP 1)! Verifique.');                      </script>                      <?php                   }                   else {                    for($ic=0; $ic<$total; $ic++){                       $mostra = mysqli_fetch_row($query);                       $controle       = $mostra[0];                       $codi_cli       = $mostra[1];                       $n_hawb         = $mostra[2];                       $reme_envio     = $mostra[3];                       $dt_envio_a     = $mostra[4];                       $dt_baixa       = $mostra[5];                       $cod_barra      = $mostra[6];                    }                    //Verifica se omovimento foi lançado                    If ($dt_lista == '0000-00-00' ) {                       $n_hawb='';                       ?>                       <script language="javascript"> window.location.href=("envia_fisico_remessa.php")                         alert('Esta HAWB não foi entregue ao destinatário (BIP 2)! Verifique.');                       </script>                       <?php                    }                    If ($dt_baixa == '0000-00-00' ) {                       $n_hawb='';                       ?>                       <script language="javascript"> window.location.href=("envia_fisico_remessa.php")                         alert('Esta HAWB não foi baixada no sistema (BIP 3)! Verifique.');                       </script>                       <?php                    }                    $_SESSION['controle_m']    =$controle;                    $_SESSION['codi_cli_m']    =$codi_cli;                    $_SESSION['n_hawb_m']      =$n_hawb;                    $_SESSION['cod_barra_m']   =$cod_barra;                                        //Pega nome clinete na tabela cli_for                                       $resultado = mysqli_query ($con,"SELECT nome FROM cli_for                    WHERE cnpj_cpf='$codi_cli'");                    $total = mysqli_num_rows($resultado);                    for($i=0; $i<$total; $i++){                       $dados = mysqli_fetch_row($resultado);                       $nome_cliente      =$dados[0];                    }                    $_SESSION['nome_cliente_m']   =$nome_cliente;                    //Verifica se a HAWB lançada já foi enviada para a origem                    If (($reme_envio <> '') and ($dt_envio<>'0000-00-00')) {                       $n_hawb='';                       ?>                         <script language="javascript"> window.location.href=("envia_fisico_remessa.php")                         alert('HAWB já incluida em lista de devolução a origem ! Verifique.');                         </script>                       <?php                    }                    If(($dt_lista<>'0000-00-00') and ($dt_baixa<>'0000-00-00') and ($dt_envio_a=='0000-00-00')) {                       //verifica se o registro é do mesmo cliente                       $dt_envio         =$_SESSION['dt_envio_m'];                       $controle         =$_SESSION['controle_m'];                       $v_n_remessa      =$_SESSION['n_remessa_m'];                       $codi_cli         =$_SESSION['codi_cli_m'];					                          $dt_envio  = explode("/",$dt_envio);                       $v_dt_envio = $dt_envio[2]."-".$dt_envio[1]."-".$dt_envio[0];                                              $pesquisa = mysqli_query ($con,"SELECT codi_cli FROM remessa                       WHERE controle='$controle'");                       $total = mysqli_num_rows($pesquisa);                       for($i=0; $i<$total; $i++){                          $dados = mysqli_fetch_row($pesquisa);                          $c_codicli      =$dados[0];                       }                       if ($c_codicli==$codi_cli) {                           //Efetua a gravaçãoda alteraçãono registro                                                      $alteracao = "UPDATE remessa SET dt_envio='$v_dt_envio',remessa_envio='$v_n_remessa',estatus='BIP4'                           WHERE controle='$controle'";                           if (mysqli_query($con,$alteracao)) {                              //Atualiza a tabela log_operação sistema                              $programa     =$_SESSION['programa_m'];                              $matricula_m  =$_SESSION['matricula_m'];                              $hora         = date ('H:i:s');                              $data         = date('Y-m-d');                              $n_hawb       =$_SESSION['n_hawb_m'];                                                            $inclui="INSERT INTO log_operacao_sistema(matricula,tarefa_executada,data,hora,rotina,n_hawb)                              VALUES('$matricula_m','Elabora Lista Envio HAWB Origem','$data','$hora','$programa','$n_hawb')";                              mysqli_query($con,$inclui);                              $cod_barra    =$_SESSION['cod_barra_m'];							                                //////////////////Atualiza a tabela de histórico HAWB /////////////////////////////////                              $atualiza="INSERT INTO controle_reentrega (n_hawb,dt_evento,ocorrencia,cod_barra,ordem)                              VALUES('$n_hawb','$v_dt_envio','HAWB devolvida a origem.','$cod_barra','5')";                              mysqli_query($con,$atualiza);                              $resp_grava="Gravação bem sucedida !";							                                //Atualiza a tabela de controle de numero de remessas                              $n_remes=   $_SESSION['n_reme'];                                                            $verifi="SELECT numero FROM nu_reme_manu WHERE numero='$n_remes'";                              $query = mysqli_query($con,$verifi) or die ("Não foi possivel acessar o banco_2");                              $achou = mysqli_num_rows($query);                              If ($achou == 0 ) {                                 $atualiza = "INSERT INTO nu_reme_manu(numero,dt_remessa)                                 values('$n_remes','$v_dt_envio')";                                 mysqli_query($con,$atualiza);                              }                              $n_hawb      ='';                              $controle    ='';                              unset($_SESSION['controle_m']);                              $v_n_remessa  =$_SESSION['v_n_remessa_m'];                           }                           else {                              $resp_grava="Problemas na gravação!";                           }                       }                       else {                           ?>                            <script language="javascript"> window.location.href=("envia_fisico_remessa.php")                             alert('HAWB pertence a outro cliente diferente daquele da lista em elaboração ! Verifique.');                            </script>                           <?php                       }                    }                  }               }        break;        case 'seleciona':              $n_remessa                  =$_POST['remessa_envio'];              $rs                         =explode("-",$n_remessa);              $v_n_remessa                =$rs[0];              $cliente                    =$rs[1];              $_SESSION['cliente_m']      =$cliente;              $r_dt_envio                 =$rs[2];              $r_dt_envio                 = explode("/",$r_dt_envio);              $t_dt_envio                 = $r_dt_envio[2]."-".$r_dt_envio[1]."-".$r_dt_envio[0];              $_SESSION['dt_envio_m']     =$t_dt_envio;              $_SESSION['n_remessa_m']    =$v_n_remessa;                            //Pega o nome do cliente                            $resultado = mysqli_query ($con,"SELECT nome FROM cli_for              WHERE cnpj_cpf='$cliente'");              $total = mysqli_num_rows($resultado);              for($i=0; $i<$total; $i++){                $dados = mysqli_fetch_row($resultado);                $nome_cliente      =$dados[0];              }			  if(isset($nome_cliente)) {                 $_SESSION['nome_cliente_m']   =$nome_cliente;			  }			  else {				 $_SESSION['nome_cliente_m']   =''; 			  }        break;        case 'imprime':               $v_remessa    =$_SESSION['n_remessa_m'];			                  $cliente      =$_SESSION['cliente_m'];                              $pega_cli=mysqli_query($con,"SELECT nome FROM cli_for               WHERE cnpj_cpf='$cliente'");               $total = mysqli_num_rows($pega_cli);               for($i=0; $i<$total; $i++){                 $dados = mysqli_fetch_row($pega_cli);                 $nome_cliente  =$dados[0];               }               $_SESSION['nome_cliente_m']  =$nome_cliente;                 require_once("gera_relat_remessa_envio.php");         break;        default:    }    include ("campo_calendario.php");	if(isset($_POST['cod_barra'])) {       $codi_barra     =$_POST['cod_barra'];	}	else {	   $codi_barra     ='';	}        if ($codi_barra<>'') {       $_SESSION['cod_barra_g']   =$codi_barra;              $resp_grava='';              $verifi="SELECT controle,codi_cli,n_hawb,remessa_envio,dt_envio,dt_baixa       FROM remessa       WHERE cod_barra='$codi_barra'";       $query = mysqli_query($con,$verifi) or die ("Não foi possivel acessar o banco");       $total = mysqli_num_rows($query);       //Verifica se omovimento foi lançado       If ($total == 0 ) {          $codi_barra='';          ?>          <script language="javascript"> window.location.href=("envia_fisico_remessa.php")           alert('Esta HAWB não foi lançada no sistema (BIP 1)! Verifique.');          </script>          <?php       }       else {         for($ic=0; $ic<$total; $ic++){           $mostra = mysqli_fetch_row($query);           $controle       = $mostra[0];           $codi_cli       = $mostra[1];           $n_hawb         = $mostra[2];           $reme_envio     = $mostra[3];           $dt_envio_a     = $mostra[4];           $dt_baixa       = $mostra[5];       }        //Verifica se omovimento foi lançado        If ($dt_lista == '0000-00-00' ) {           $codi_barra='';           ?>           <script language="javascript"> window.location.href=("envia_fisico_remessa.php")             alert('Esta HAWB não foi entregue ao destinatário (BIP 2)! Verifique.');           </script>           <?php        }        If ($dt_baixa == '0000-00-00' ) {           $codi_barra='';           ?>           <script language="javascript"> window.location.href=("envia_fisico_remessa.php")             alert('Esta HAWB não foi baixada no sistema (BIP 3)! Verifique.');           </script>           <?php        }        $_SESSION['controle_m']    =$controle;        $_SESSION['codi_cli_m']    =$codi_cli;        $_SESSION['n_hawb_m']      =$n_hawb;		        //Pega nome clinete na tabela cli_for               $resultado = mysqli_query ($con,"SELECT nome FROM cli_for        WHERE cnpj_cpf='$codi_cli'");        $total = mysqli_num_rows($resultado);        for($i=0; $i<$total; $i++){           $dados = mysqli_fetch_row($resultado);           $nome_cliente      =$dados[0];        }        $_SESSION['nome_cliente_m']   =$nome_cliente;        //Verifica se a HAWB lançada já tem entregador definido                $localiza = "SELECT controle,dt_envio FROM remessa        WHERE ((controle='$controle')        AND (remessa_envio='$v_n_remessa'))";        $query = mysqli_query($con,$localiza) or die ("Não foi possivel acessar o banco 1");        $achou = mysqli_num_rows($query);        If ($achou == 0 ) {           $codi_barra='';           ?>             <script language="javascript"> window.location.href=("envia_fisico_remessa_continua.php")             alert('HAWB já consta da lista de envio ! Verifique.');             </script>           <?php        }        else {           //verifica se o registro é do mesmo cliente           $dt_envio         =$_SESSION['dt_envio_m'];           $controle         =$_SESSION['controle_m'];           $v_n_remessa      =$_SESSION['n_remessa_m'];           $codi_cli         =$_SESSION['codi_cli_m'];		              $dt_envio  = explode("/",$dt_envio);           $v_dt_envio = $dt_envio[2]."-".$dt_envio[1]."-".$dt_envio[0];                      $pesquisa = mysqli_query ($con,"SELECT codi_cli FROM remessa           WHERE controle='$controle'");           $total = mysqli_num_rows($pesquisa);           for($i=0; $i<$total; $i++){              $dados = mysqli_fetch_row($pesquisa);              $c_codicli      =$dados[0];           }           if ($c_codicli==$codi_cli) {               //Efetua a gravaçãoda alteraçãono registro                              $alteracao = "UPDATE remessa SET dt_envio='$v_dt_envio',remessa_envio='$v_n_remessa',estatus='BIP4'               WHERE controle='$controle'";               if (mysqli_query($con,$alteracao)) {                  //Atualiza a tabela log_operação sistema                  $programa     =$_SESSION['programa_m'];                  $matricula_m  =$_SESSION['matricula_m'];                  $hora         = date ('H:i:s');                  $data         = date('Y-m-d');                  $n_hawb       =$_SESSION['n_hawb_m'];                                    $inclui="INSERT INTO log_operacao_sistema(matricula,tarefa_executada,data,hora,rotina,n_hawb)                  VALUES('$matricula_m','Continua Lista envio HAWB Origem','$data','$hora','$programa','$n_hawb')";                  mysqli_query($con,$inclui);                  $codi_barra   =$_SESSION['cod_barra_g'];				                 //////////////////Atualiza a tabela de histórico HAWB /////////////////////////////////                  $atualiza="INSERT INTO controle_reentrega (n_hawb,dt_evento,ocorrencia,cod_barra,ordem)                  VALUES('$n_hawb','$v_dt_envio','HAWB devolvida a origem.','$codi_barra','5')";                  mysqli_query($con,$atualiza);				                    $resp_grava="Registro  bem sucedido na remessa de envio!";				                    //Atualiza a tabela de controle de numero de remessas                  $n_remes=   $_SESSION['n_reme'];				                    $verifi="SELECT numero FROM nu_reme_manu WHERE numero='$n_remes'";                  $query = mysqli_query($con,$verifi) or die ("Não foi possivel acessar o banco_2");                  $achou = mysqli_num_rows($query);                  If ($achou == 0 ) {                     $atualiza = "INSERT INTO nu_reme_manu(numero,dt_remessa)                     values('$n_remes','$v_dt_envio')";                     mysqli_query($con,$atualiza);                  }                  $codi_barra          ='';                  $controle            ='';                                    unset($_SESSION['controle_m']);                  $v_n_remessa  =$_SESSION['v_n_remessa_m'];               }               else {                  $resp_grava="Problemas no registroda remessa de envio";               }           }           else {               ?>                <script language="javascript"> window.location.href=("envia_fisico_remessa.php")                  alert('HAWB pertence a outro cliente diferente daquele da lista em elaboração ! Verifique.');                </script>               <?php           }        }       }    }?><html>  <title>envia_fisico_remessa_continua.php</title>  <head>   <style>		body, p, div, td, input, select, textarea {			font-family: verdana,arial,helvetica;			font-size:12px;			color:#000000;			text-decoration: none;		}		input,textarea {			@if (is.ie) {				color: #efefef; background-color:#F0F8FF; border: 1px solid #6495ED ;				/*border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; */			}		}		textarea { overflow:auto }   </style>   <script>       function salva(campo){            cadastro_1.submit()       }          <!-- FUNÇÃO PARA DESABILITAR O CRTL+J-->   function retornoCodbar(evt, valor){    <!--ENTER = 13 -->    if (window.event){       var tecla = window.event.keyCode;       if(tecla==13){         <!--alert('Código de barras: '+valor);-->         window.event.returnValue = false;       }    }    else{       var tecla = (evt.which) ? evt.which : evt.keyCode;       if(tecla==13){          <!--alert('Código de barras: '+valor);-->         evt.preventDefault();       }    }   }   function desabilitaCtrlJ(evt){      //ctrl+j == true+106      //ctrl+J == true+74      if (window.event){ //IE         var ctrl = event.ctrlKey;         var tecla = window.event.keyCode;         if((ctrl==true)&&((tecla==106)||(tecla==74))){            window.event.returnValue = false;         }      }      else{ //Firefox         var ctrl = evt.ctrlKey;         var tecla = (evt.which) ? evt.which : evt.keyCode;         if((ctrl==true)&&((tecla==106)||(tecla==74))){            evt.preventDefault();         }      }   }</script>      </script>  </head>  <div id="geral" align="center">    <body onkeydown="desabilitaCtrlJ(event)" topmargin="0" leftmargin="0" rightmargin="0" bottommargin="0" marginheight="0" marginwidth="0" bgcolor="#FFFFFF">     <table border="0" width="100%" bgcolor="#000000" cellspacing="0" cellpadding="0">      <tr>        <td width="20%" height="100" background="img/topleft.jpg"></td>         <td width="658" height="110"> <img border="0" src="img/cabecalho_free_jazz.jpg" width="890" height="115" border="0"></td>        <td width="15%" height="110">        <p align="right"><img border="0" src="img/topright.jpg" width="160" height="110" border="0"></td>     </tr>    </table>    <table border="0" width="100%" cellspacing="0" cellpadding="0" background="img/blue.jpg">     <tr>       <td width="50%">         <p align="left"><font face="Arial" size="2" color="#FFFFFF"><b>Sistema de Gerenciamento da Logística de Encomendas</b></font></td>       <td width="50%">         <p align="right"><font face="Arial" size="2" color="#FFFFFF"><b>Elabora Lista de Entrega Com Leitora</b></font></td>     </tr>   </table>   </table>   <table width="100%" border="0" cellspacing="0" cellpadding="0">       <tr>         <td colspan="1" align="left" width="45%"><INPUT type=button size="3" value="Ajuda"               onClick="window.open('mostra_ajuda.php','janela_1',               'scrollbars=yes,resizable=yes,width=400,height=700');" style="width:100;height:30;color=red;font: bold 16px Arial;">         </td>         <td colspan="1" color="white" align="right" width="45%" height="70"><a href="entrada.php"><img src="img/porta.gif" border="none"></td>       </tr>   </table>   <form method="POST" name="cadastro" action="envia_fisico_remessa_continua.php" border="20" align="center">      <table width="80%" heigth="300">        <tr>           <td colspan="2">            <?php               echo "<center><Font size=\"2\" face=\"ARIAL\">Selecione Remessa...:</font>";                              $resultado = mysqli_query ($con,"SELECT DISTINCT remessa.remessa_envio,remessa.codi_cli,               date_format(remessa.dt_envio,'%d/%m/%Y'),cli_for.nome               FROM remessa,cli_for               WHERE ((remessa.remessa_envio<>'')               AND (remessa.codi_cli=cli_for.cnpj_cpf))");               echo "<select name='remessa_envio' class='caixa' align=\"center\">\n";               while($linha = mysqli_fetch_row($resultado))  {                  printf("<option value='$linha[0]-$linha[1]-$linha[2]'>$linha[0] - $linha[1] - $linha[2] - $linha[3]</option>\n");               }            ?>            <input name="seleciona" type="submit" value="Selecionar Remessa">            </td>          </tr>      </table>       <table width="100%" border="1" cellpadding="5" cellspacing="0" bordercolor="#4169E1">         <tr>           <?php 		      if(isset($_SESSION['nome_cliente_m'])) {		         $nome_cliente   =$_SESSION['nome_cliente_m'];              }              else {                 $nome_cliente   ='';              }				  		   ?>           <td colspan="7" align="center"><font face="arial" size="2"><b>ENVIO FÍSICO PARA :<?php echo "$nome_cliente";?></b></font></td>         </tr>         <tr>           <td width="2%" align="center"><b>N.</b></td>           <td width="5%" align="center"><b>N. HAWB</b></td>           <td width="24%" align="center"><b>NOME</b></td>           <td width="24%" align="center"><b>RUA</b></td>           <td width="5%" align="center"><b>NUMERO</b></td>           <td width="20%" align="center"><b>BAIRRO</b></td>           <td width="15%" align="center"><b>CIDADE</b></td>         </tr>        <?php         $v_n_remessa   =$_SESSION['n_remessa_m'];		 if(isset($_SESSION['cliente_m'])){             $cliente       =$_SESSION['cliente_m'];		 }else{			 $cliente       ='';		 }		 $t_dt_envio    =$_SESSION['dt_envio_m'];		          $resultado = mysqli_query ($con,"SELECT n_hawb,nome_desti,rua_desti,         numero_desti,bairro_desti,cidade_desti         FROM remessa         WHERE ((remessa_envio='$v_n_remessa')and (codi_cli='$cliente') and (dt_envio='$t_dt_envio'))");         $total = mysqli_num_rows($resultado);         $ni=0;         for($i=0; $i<$total; $i++){          $dados = mysqli_fetch_row($resultado);          $n_hawb            =$dados[0];          $nome_desti        =$dados[1];          $rua_desti         =$dados[2];          $numero_desti      =$dados[3];          $bairro_desti      =$dados[4];          $cidade_desti      =$dados[5];          $ni=$i+1;          echo "<tr>";            echo "<td width=\"2%\" align=\"left\"><font size=\"1\" face=\"arial\">$ni</font></td>";            echo "<td width=\"5%\" align=\"left\"><font size=\"1\" face=\"arial\">$n_hawb</font></td>";            echo "<td width=\"24%\"><font size=\"1\" face=\"arial\">$nome_desti</font></td>";            echo "<td width=\"24%\"><font size=\"1\" face=\"arial\">$rua_desti</font></td>";            echo "<td width=\"5%\"><font size=\"1\" face=\"arial\">$numero_desti</font></td>";            echo "<td width=\"20%\"><font size=\"1\" face=\"arial\">$bairro_desti</font></td>";            echo "<td width=\"15%\"><font size=\"1\" face=\"arial\">$cidade_desti</font></td>";         echo "</tr>";       }    ?>    <tr>      <td colspan="7">        <div align="right">         <input name="imprime" type="submit" value="Imprimir">        </div>      </td>    </tr>  </form>  <body leftmargin="10" topmargin="10" marginwidth="10" marginheight="10">  <form name="cadastro_1" action="envia_fisico_remessa_continua.php" method="post">	<table width="50%" border="1" cellpadding="5" cellspacing="0" align="center" bordercolor="#4169E1">       <tr>           <td align="center" colspan="3"><b>Codigo Barras:</b>           <input type="text" name="cod_barra" id="cod_barra" value ="<?php echo "$codi_barra";?>" size="50" maxlength="50" onChange="salva(this)"></td>         </tr>         <tr>           <td><b>Número da HAWB:</b></td>           <td><input type="text" name="n_hawb" class="campo" id="n_hawb" size="30" maxlength="30"><input name="grava" type="submit" value="Grava"></td></td>	     </tr>         <!-- Coloca foco no primeiro campo codigo de barras do formulário -->                  <script language="JavaScript">            document.getElementById('cod_barra').focus()         </script>   	</table>  </form>  </div>  <table width="100%" border="0" cellspacing="0" cellpadding="0">      <tr>        <td color="white" align="center" width="900" height="45" colspan="8" ><?php echo "$resp_grava";?></td>      </tr>  </table>  <table width="100%" border="0" cellspacing="0" cellpadding="0">    <tr>       <td color="white" align="left" width="100%" height="40">     </tr>  </table>  <table width="100%"  border="0" cellspacing="0" cellpadding="0">    <tr>      <td background="img/blue.jpg" align="left" width="100%" height="45px"><center><font face="arial" size="1" color="white">Todos Direitos Reservados a NUNESTEC Tecnologia</font></td>    </tr>  </table></body></html>